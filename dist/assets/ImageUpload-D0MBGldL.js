import{c as W,u as F,aA as Q,aB as X,aC as Z,aD as K,aE as D,aF as ee,aG as re,aH as te,aI as ae,aJ as se,s as x,r as j,G as Y,a as $,j as r,I as C,X as R}from"./index-Ba-_IHuQ.js";import{u as oe,c as ie}from"./cityUtils-DwiwOoBI.js";import{S as q,a as T,b as I,c as z,d as B}from"./select-B0LLBn5t.js";import{L as N}from"./label-3yzes-iA.js";import{u as ne,g as le}from"./usePropertyLayouts-0iGFrxcO.js";import{C as M,a as H,c as V,d as G,b as O}from"./card-DocFJD5R.js";import{U as L}from"./switch-CCSj0eWM.js";import{I as ce}from"./image-BgofXdSF.js";/**
 * @license lucide-react v0.515.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]],ue=W("file-image",de);/**
 * @license lucide-react v0.515.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],je=W("trending-up",pe),ge=()=>{const{user:t}=F();return{logActivity:{propertyCreated:async o=>t!=null&&t.id?await Q(t.id,o):{success:!1,error:"User not authenticated"},propertyUpdated:async o=>t!=null&&t.id?await X(t.id,o):{success:!1,error:"User not authenticated"},propertyDeleted:async o=>t!=null&&t.id?await Z(t.id,o):{success:!1,error:"User not authenticated"},propertyVisibilityChanged:async o=>t!=null&&t.id?await K(t.id,o):{success:!1,error:"User not authenticated"},propertyStatusChanged:async o=>t!=null&&t.id?await D(t.id,o):{success:!1,error:"User not authenticated"},priceChanged:async o=>t!=null&&t.id?await ee(t.id,o):{success:!1,error:"User not authenticated"},imagesUpdated:async o=>t!=null&&t.id?await re(t.id,o):{success:!1,error:"User not authenticated"},profileUpdated:async o=>t!=null&&t.id?await te(t.id,o):{success:!1,error:"User not authenticated"},userLogin:async()=>t!=null&&t.id?await ae(t.id):{success:!1,error:"User not authenticated"},userLogout:async()=>t!=null&&t.id?await se(t.id):{success:!1,error:"User not authenticated"}},isAuthenticated:!!(t!=null&&t.id)}};function me(){const{user:t,isAdmin:h,isSeller:o}=F(),{logActivity:f}=ge(),a=async e=>{if(!t||!h&&!o)return!1;try{const n={title_ar:e.title_ar,title_en:e.title_en,title_tr:e.title_tr,description_ar:e.description_ar,description_en:e.description_en,description_tr:e.description_tr,price:parseFloat(e.price)||0,currency:e.currency,deposit:parseFloat(e.deposit)||0,deposit_currency:e.deposit_currency,commission:parseFloat(e.commission)||0,commission_currency:e.commission_currency,city:e.city,district:e.district,property_type_id:e.property_type,property_layout_id:e.property_layout_id||null,listing_type:e.listing_type,bedrooms:parseInt(e.bedrooms)||null,bathrooms:parseInt(e.bathrooms)||null,area:parseFloat(e.area)||null,status:e.status,images:e.images,cover_image:e.cover_image,is_featured:e.is_featured,is_student_housing:e.is_student_housing,student_housing_gender:e.student_housing_gender,user_id:t.id,created_by:t.id},{data:c,error:s}=await x.from("properties").insert(n).select().single();if(s)return console.error("Error creating property:",s),!1;try{await f.propertyCreated({title:e.title_ar||e.title_en||e.title_tr||"New Property",type:e.property_type,price:parseFloat(e.price)||void 0,currency:e.currency,location:`${e.city}, ${e.district}`,bedrooms:parseInt(e.bedrooms)||void 0,bathrooms:parseInt(e.bathrooms)||void 0,area:parseFloat(e.area)||void 0,property_id:c.id}),console.log("Property creation activity logged successfully")}catch(_){console.warn("Failed to log property creation activity:",_)}return console.log("Property created successfully:",c),!0}catch(n){return console.error("Unexpected error creating property:",n),!1}},d=async e=>{if(!t)return{error:{message:"User not authenticated"}};try{const{data:n}=await x.from("properties").select("title_ar, title_en, title_tr, id").eq("id",e).single();console.log("Deleting related records for property:",e);try{const{error:s}=await x.from("property_activities").delete().eq("property_id",e);s&&console.warn("Error deleting property activities:",s)}catch(s){console.warn("Exception deleting property activities:",s)}console.log("Skipping user_activity_logs deletion - will be handled by database constraints");try{const{error:s}=await x.from("property_views").delete().eq("property_id",e);s&&console.warn("Error deleting property views:",s)}catch(s){console.warn("Exception deleting property views:",s)}try{const{error:s}=await x.from("favorites").delete().eq("property_id",e);s&&console.warn("Error deleting favorites:",s)}catch(s){console.warn("Exception deleting favorites:",s)}try{const{error:s}=await x.from("property_reports").delete().eq("property_id",e);s&&console.warn("Error deleting property reports:",s)}catch(s){console.warn("Exception deleting property reports:",s)}try{const{error:s}=await x.from("property_comments").delete().eq("property_id",e);s&&console.warn("Error deleting property comments:",s)}catch(s){console.warn("Exception deleting property comments:",s)}const{error:c}=await x.from("properties").delete().eq("id",e);if(c)return console.error("Error deleting property:",c),{error:c};if(n)try{await f.propertyDeleted({title:n.title_ar||n.title_en||n.title_tr||"Unknown Property",property_id:e,reason:"user_request"}),console.log("Property deletion activity logged successfully")}catch(s){console.warn("Failed to log property deletion activity:",s)}return console.log("Property and all related records deleted successfully"),{error:null}}catch(n){return console.error("Unexpected error deleting property:",n),{error:{message:"An unexpected error occurred"}}}},l=async(e,n)=>{if(!t)return{error:{message:"User not authenticated"}};try{const{data:c,error:s}=await x.from("properties").update(n).eq("id",e).select().single();if(s)return console.error("Error updating property:",s),{error:s};try{const _=Object.keys(n);await f.propertyUpdated({title:c.title_ar||c.title_en||c.title_tr||"Unknown Property",property_id:e,changes:_}),console.log("Property update activity logged successfully")}catch(_){console.warn("Failed to log property update activity:",_)}return console.log("Property updated successfully:",c),{data:c,error:null}}catch(c){return console.error("Unexpected error updating property:",c),{error:{message:"An unexpected error occurred"}}}};return{handleCreateProperty:a,handleDeleteProperty:d,handleUpdateProperty:async(e,n)=>{if(!t)return{error:{message:"User not authenticated"}};try{const{data:c,error:s}=await x.from("properties").update(n).eq("id",e).select().single();return s?(console.error("Error updating property:",s),{error:s}):(console.log("Property updated successfully:",c),{data:c,error:null})}catch(c){return console.error("Unexpected error updating property:",c),{error:{message:"An unexpected error occurred"}}}},togglePropertyStatus:async(e,n)=>await l(e,{status:n==="available"?"pending":"available"}),toggleFeaturedStatus:async(e,n)=>await l(e,{is_featured:!n}),fetchUserProperties:async()=>{if(!t)return{data:[],error:{message:"User not authenticated"}};try{let e=x.from("properties").select("*");o&&!h&&(e=e.eq("user_id",t.id));const{data:n,error:c}=await e.order("created_at",{ascending:!1});return c?(console.error("Error fetching properties:",c),{data:[],error:c}):{data:n||[],error:null}}catch(e){return console.error("Unexpected error fetching properties:",e),{data:[],error:{message:"An unexpected error occurred"}}}},canCreateProperty:h||o,canManageAllProperties:h,addProperty:a,deleteProperty:async e=>!(await d(e)).error,addingProperty:!1}}const Pe=()=>{const[t,h]=j.useState([]),[o,f]=j.useState(!0),{user:a,isAdmin:d,isSeller:l}=F(),{toast:m}=Y(),{handleCreateProperty:e,handleDeleteProperty:n,handleUpdateProperty:c,addingProperty:s}=me(),_=async()=>{try{f(!0),console.log("Fetching properties for user:",a==null?void 0:a.email,"isAdmin:",d,"isSeller:",l);let p=x.from("properties").select(`
          *,
          property_types(name_ar, name_en, name_tr),
          property_layouts(name_ar, name_en, name_tr)
        `);d?console.log("Admin user - fetching all properties"):l?(console.log("Seller user - fetching own properties"),p=p.or(`created_by.eq.${a==null?void 0:a.id},user_id.eq.${a==null?void 0:a.id}`)):(console.log("Regular user - fetching available properties"),p=p.eq("status","available").neq("hidden_by_admin",!0));const{data:i,error:g}=await p.order("created_at",{ascending:!1});if(g){console.error("Error fetching properties:",g);let v=x.from("properties").select("*");d||(l?v=v.or(`created_by.eq.${a==null?void 0:a.id},user_id.eq.${a==null?void 0:a.id}`):v=v.eq("status","available").neq("hidden_by_admin",!0));const{data:P,error:U}=await v.order("created_at",{ascending:!1});if(U){console.error("Fallback query also failed:",U),m({title:"خطأ",description:"فشل في تحميل العقارات",variant:"destructive"});return}console.log("Using fallback query result:",(P==null?void 0:P.length)||0);const J=(P||[]).map(E=>({...E,images:Array.isArray(E.images)?E.images:typeof E.images=="string"?[E.images]:[]}));h(J);return}console.log("Properties fetched successfully:",(i==null?void 0:i.length)||0);const w=(i||[]).map(v=>({...v,images:Array.isArray(v.images)?v.images:typeof v.images=="string"?[v.images]:[],property_types:v.property_types?{...v.property_types,id:v.property_type_id||"",is_active:!0,created_at:new Date().toISOString(),created_by:v.created_by,updated_at:new Date().toISOString()}:void 0}));h(w)}catch(p){console.error("Error in fetchProperties:",p),m({title:"خطأ",description:"حدث خطأ أثناء تحميل العقارات",variant:"destructive"})}finally{f(!1)}},k=async p=>{const i=await e(p);return i&&await _(),i},S=async p=>(await n(p)).error?!1:(await _(),!0),A=async(p,i)=>{let g;i==="available"?g="hidden":i==="hidden"||i==="sold"||i==="rented"?g="available":g="sold",console.log(`Toggling property ${p} from ${i} to ${g}`);const w=await c(p,{status:g});return w.error||await _(),w},u=async(p,i)=>{console.log(`Toggling featured status for property ${p} from ${i} to ${!i}`);const g=await c(p,{is_featured:!i});return g.error||await _(),g},y=async(p,i)=>{const w=i==="pending"||i==="hidden"?"available":"pending",v=w==="pending";console.log(`Admin toggling hide status for property ${p} from ${i} to ${w}`);const U=await c(p,{status:w,hidden_by_admin:v});return U.error||await _(),U},b=async(p,i)=>{const g=i==="sold"||i==="rented"?"available":"sold";console.log(`Toggling sold status for property ${p} from ${i} to ${g}`);const w=await c(p,{status:g});return w.error||await _(),w};return j.useEffect(()=>{a&&(console.log("User detected, fetching properties..."),_())},[a,d,l]),{properties:t,loading:o,refetch:_,isAdmin:d,addingProperty:s,user:a,addProperty:k,deleteProperty:S,togglePropertyStatus:A,toggleFeaturedStatus:u,toggleHideStatus:y,toggleSoldStatus:b,fetchProperties:_,handleDeleteProperty:S}},Ue=({value:t,onChange:h,required:o=!1,className:f=""})=>{const{currentLanguage:a}=$(),{propertyTypes:d,loading:l}=oe();return l?r.jsxs("div",{className:`space-y-2 ${f}`,children:[r.jsxs(N,{children:[a==="ar"?"نوع العقار":a==="tr"?"Emlak Türü":"Property Type",o&&" *"]}),r.jsx("div",{className:"animate-shimmer bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 bg-[length:200%_100%] h-10 rounded"})]}):r.jsxs("div",{className:`space-y-2 ${f}`,children:[r.jsxs(N,{htmlFor:"property-type",children:[a==="ar"?"نوع العقار":a==="tr"?"Emlak Türü":"Property Type",o&&" *"]}),r.jsxs(q,{value:t,onValueChange:h,required:o,children:[r.jsx(T,{id:"property-type",children:r.jsx(I,{placeholder:a==="ar"?"اختر نوع العقار":a==="tr"?"Emlak türünü seçin":"Select property type"})}),r.jsx(z,{children:d.map(m=>r.jsx(B,{value:m.id,children:ie(m,a)},m.id))})]})]})},Ee=({value:t,onValueChange:h,placeholder:o})=>{const{currentLanguage:f}=$(),a=[{value:"EUR",label:"EUR (€)",name_ar:"يورو",name_tr:"Euro"},{value:"GBP",label:"GBP (£)",name_ar:"جنيه إسترليني",name_tr:"İngiliz Sterlini"},{value:"USD",label:"USD ($)",name_ar:"دولار أمريكي",name_tr:"ABD Doları"}],d=l=>f==="ar"?`${l.value} - ${l.name_ar}`:f==="tr"?`${l.value} - ${l.name_tr}`:l.label;return r.jsxs(q,{value:t,onValueChange:h,children:[r.jsx(T,{children:r.jsx(I,{placeholder:o||(f==="ar"?"اختر العملة":"Select Currency")})}),r.jsx(z,{children:a.map(l=>r.jsx(B,{value:l.value,children:d(l)},l.value))})]})},Se=({value:t,onChange:h,propertyTypeId:o,required:f=!1,className:a=""})=>{const{currentLanguage:d}=$(),{propertyLayouts:l,loading:m}=ne(),e=o?l.filter(n=>n.property_type_id===o):l;return m?r.jsxs("div",{className:`space-y-2 ${a}`,children:[r.jsxs(N,{children:[d==="ar"?"تقسيم العقار":d==="tr"?"Emlak Düzeni":"Property Layout",f&&" *"]}),r.jsx("div",{className:"animate-shimmer bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 bg-[length:200%_100%] h-10 rounded"})]}):r.jsxs("div",{className:`space-y-2 ${a}`,children:[r.jsxs(N,{htmlFor:"property-layout",children:[d==="ar"?"تقسيم العقار":d==="tr"?"Emlak Düzeni":"Property Layout",f&&" *"]}),r.jsxs(q,{value:t,onValueChange:h,required:f,children:[r.jsx(T,{id:"property-layout",disabled:!o,children:r.jsx(I,{placeholder:o?d==="ar"?"اختر تقسيم العقار":"Select property layout":d==="ar"?"اختر نوع العقار أولاً":"Select property type first"})}),r.jsx(z,{children:e.map(n=>r.jsx(B,{value:n.id,children:le(n,d)},n.id))})]}),!o&&r.jsx("p",{className:"text-sm text-gray-500",children:d==="ar"?"يجب اختيار نوع العقار أولاً":"Please select property type first"})]})},Ce=({onCoverImageChange:t,onImagesChange:h,coverImage:o,images:f})=>{const{currentLanguage:a,t:d}=$(),{toast:l}=Y(),[m,e]=j.useState(!1),n=j.useRef(null),c=j.useRef(null),s=async u=>{try{const y=u.name.split(".").pop(),b=`${Date.now()}-${Math.random().toString(36).substring(2)}.${y}`,p=b;console.log("Uploading image:",b);const{error:i,data:g}=await x.storage.from("property-images").upload(p,u);if(i)throw console.error("Upload error:",i),i;const{data:w}=x.storage.from("property-images").getPublicUrl(p);return console.log("Image uploaded successfully:",w.publicUrl),w.publicUrl}catch(y){return console.error("Error uploading image:",y),null}},_=async u=>{if(m){console.log("Already uploading, preventing duplicate upload");return}try{if(e(!0),!u.target.files||u.target.files.length===0)return;const y=u.target.files[0];if(!y.type.startsWith("image/")){l({title:a==="ar"?"خطأ":"Error",description:a==="ar"?"يجب أن يكون الملف صورة":"File must be an image",variant:"destructive"});return}if(y.size>5*1024*1024){l({title:a==="ar"?"خطأ":"Error",description:a==="ar"?"حجم الصورة يجب أن يكون أقل من 5 ميجابايت":"Image size must be less than 5MB",variant:"destructive"});return}const b=await s(y);if(b)t(b),l({title:a==="ar"?"نجح":"Success",description:a==="ar"?"تم رفع صورة الغلاف بنجاح":"Cover image uploaded successfully"});else throw new Error("Failed to upload image")}catch(y){console.error("Error uploading cover image:",y),l({title:a==="ar"?"خطأ":"Error",description:a==="ar"?"فشل في رفع الصورة":"Failed to upload image",variant:"destructive"})}finally{e(!1),u.target&&(u.target.value="")}},k=async u=>{if(m){console.log("Already uploading, preventing duplicate upload");return}try{if(e(!0),!u.target.files||u.target.files.length===0)return;const y=Array.from(u.target.files);for(const g of y){if(!g.type.startsWith("image/")){l({title:a==="ar"?"خطأ":"Error",description:a==="ar"?"جميع الملفات يجب أن تكون صور":"All files must be images",variant:"destructive"});return}if(g.size>5*1024*1024){l({title:a==="ar"?"خطأ":"Error",description:a==="ar"?"حجم كل صورة يجب أن يكون أقل من 5 ميجابايت":"Each image size must be less than 5MB",variant:"destructive"});return}}const b=y.map(g=>s(g)),i=(await Promise.all(b)).filter(g=>g!==null);i.length>0&&(h([...f,...i]),l({title:a==="ar"?"نجح":"Success",description:a==="ar"?`تم رفع ${i.length} صورة بنجاح`:`${i.length} images uploaded successfully`})),i.length<y.length&&l({title:a==="ar"?"تحذير":"Warning",description:a==="ar"?"فشل في رفع بعض الصور":"Some images failed to upload",variant:"destructive"})}catch(y){console.error("Error uploading images:",y),l({title:a==="ar"?"خطأ":"Error",description:a==="ar"?"فشل في رفع الصور":"Failed to upload images",variant:"destructive"})}finally{e(!1),u.target&&(u.target.value="")}},S=u=>{const y=f.filter((b,p)=>p!==u);h(y)},A=()=>{t("")};return r.jsxs("div",{className:"space-y-6",children:[r.jsxs(M,{children:[r.jsxs(H,{children:[r.jsxs(V,{className:"flex items-center gap-2",children:[r.jsx(ue,{className:"w-5 h-5"}),d("coverImageRequired")]}),r.jsx(G,{children:d("coverImageDescription")})]}),r.jsxs(O,{className:"space-y-4",children:[o?r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:o,alt:"Cover",className:"w-full h-48 object-cover rounded-lg"}),r.jsx(C,{variant:"destructive",size:"sm",className:"absolute top-2 right-2",onClick:A,disabled:m,children:r.jsx(R,{className:"w-4 h-4"})})]}):r.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-gray-400 transition-colors",onClick:()=>{var u;return!m&&((u=n.current)==null?void 0:u.click())},children:[r.jsx(L,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:d("clickToUploadCover")}),r.jsx("p",{className:"text-sm text-gray-400 mt-2",children:d("maxFileSize")})]}),r.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:_,className:"hidden",disabled:m}),r.jsx(C,{onClick:()=>{var u;return!m&&((u=n.current)==null?void 0:u.click())},disabled:m,variant:"outline",className:"w-full",children:m?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full animate-spin mr-2"}),a==="ar"?"جارٍ الرفع...":a==="tr"?"Yükleniyor...":"Uploading..."]}):r.jsxs(r.Fragment,{children:[r.jsx(L,{className:"w-4 h-4 mr-2"}),d("uploadCoverImage")]})})]})]}),r.jsxs(M,{children:[r.jsxs(H,{children:[r.jsxs(V,{className:"flex items-center gap-2",children:[r.jsx(ce,{className:"w-5 h-5"}),d("additionalImages")]}),r.jsx(G,{children:d("additionalImagesDescription")})]}),r.jsxs(O,{className:"space-y-4",children:[f.length>0&&r.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:f.map((u,y)=>r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:u,alt:`Property ${y+1}`,className:"w-full h-32 object-cover rounded-lg"}),r.jsx(C,{variant:"destructive",size:"sm",className:"absolute top-1 right-1 p-1 h-auto",onClick:()=>S(y),disabled:m,children:r.jsx(R,{className:"w-3 h-3"})})]},y))}),r.jsx("input",{ref:c,type:"file",accept:"image/*",multiple:!0,onChange:k,className:"hidden",disabled:m}),r.jsx(C,{onClick:()=>{var u;return!m&&((u=c.current)==null?void 0:u.click())},disabled:m,variant:"outline",className:"w-full",children:m?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full animate-spin mr-2"}),a==="ar"?"جارٍ الرفع...":a==="tr"?"Yükleniyor...":"Uploading..."]}):r.jsxs(r.Fragment,{children:[r.jsx(L,{className:"w-4 h-4 mr-2"}),d("uploadAdditionalImages")]})})]})]})]})};export{Ee as C,Ce as I,Ue as P,je as T,Se as a,ge as b,Pe as u};
